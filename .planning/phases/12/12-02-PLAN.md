---
phase: 12-export
plan: 02
type: execute
wave: 2
depends_on: [12-01]
files_modified:
  - src/event_dedup/cli/__init__.py
  - src/event_dedup/cli/__main__.py
  - frontend/src/api/client.ts
  - frontend/src/components/ExportPage.tsx
  - frontend/src/App.tsx
  - frontend/src/types/index.ts
  - tests/test_export_cli.py
autonomous: true
requirements: [EXP-04, EXP-05]

must_haves:
  truths:
    - "CLI command `uv run python -m event_dedup.cli export` writes JSON files to the output directory"
    - "CLI --created-after and --modified-after flags filter exported events by timestamp"
    - "CLI --output-dir flag controls where export files are written (defaults to ./export)"
    - "CLI splits output into 200-event files with export_{timestamp}_part_{N}.json naming"
    - "Frontend export page has datetime pickers for created_after and modified_after filters"
    - "Frontend export page triggers download of JSON or ZIP file via POST /api/export"
    - "Frontend export page is accessible via navigation link"
  artifacts:
    - path: "src/event_dedup/cli/__main__.py"
      provides: "CLI entry point with export subcommand"
      min_lines: 40
    - path: "frontend/src/components/ExportPage.tsx"
      provides: "Export page with datetime pickers and download button"
      min_lines: 50
    - path: "tests/test_export_cli.py"
      provides: "CLI export tests"
      min_lines: 30
  key_links:
    - from: "src/event_dedup/cli/__main__.py"
      to: "src/event_dedup/export/service.py"
      via: "import and call query_and_export + chunk_events"
      pattern: "from event_dedup\\.export\\.service import"
    - from: "src/event_dedup/cli/__main__.py"
      to: "src/event_dedup/db/session.py"
      via: "get_session_factory for async DB access"
      pattern: "get_session_factory"
    - from: "frontend/src/components/ExportPage.tsx"
      to: "frontend/src/api/client.ts"
      via: "exportEvents function call"
      pattern: "exportEvents"
    - from: "frontend/src/App.tsx"
      to: "frontend/src/components/ExportPage.tsx"
      via: "Route and nav link"
      pattern: "ExportPage"
---

<objective>
Build the CLI export command and frontend export page, both wrapping the export service created in Plan 01.

Purpose: Give operators two additional ways to export canonical events: a CLI command for automation/scripting, and a frontend page for interactive use with visual date pickers and download.

Output: Working CLI at `uv run python -m event_dedup.cli export`, frontend export page at `/export` route, tests for CLI.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12/12-RESEARCH.md
@.planning/phases/12/12-01-SUMMARY.md
@src/event_dedup/export/service.py
@src/event_dedup/api/routes/export.py
@src/event_dedup/worker/__main__.py
@frontend/src/api/client.ts
@frontend/src/App.tsx
@frontend/src/types/index.ts
@tests/conftest.py

<interfaces>
<!-- Key types and contracts from Plan 01 that this plan depends on. -->

From src/event_dedup/export/service.py (created in Plan 01):
```python
EXPORT_CHUNK_SIZE = 200

def canonical_to_input_format(canonical: CanonicalEvent) -> dict:
    """Transform a CanonicalEvent ORM object to input JSON format."""

def chunk_events(
    events: list[dict],
    chunk_size: int = EXPORT_CHUNK_SIZE,
    filters: dict | None = None,
) -> list[tuple[str, str]]:
    """Split events into named JSON chunks. Returns list of (filename, json_content)."""

async def query_and_export(
    session: AsyncSession,
    created_after: datetime | None = None,
    modified_after: datetime | None = None,
) -> list[dict]:
    """Query canonical events with optional date filters, return as input-format dicts."""
```

From src/event_dedup/worker/__main__.py (async CLI pattern to follow):
```python
from event_dedup.config.settings import get_settings
from event_dedup.db.session import get_session_factory

async def main() -> None:
    settings = get_settings()
    session_factory = get_session_factory()
    # ... use session_factory() as session ...

asyncio.run(main())
```

From frontend/src/api/client.ts (API client pattern):
```typescript
const API_BASE = '/api';
// POST with JSON body, handle response
const res = await fetch(`${API_BASE}/export`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(params),
});
```

From frontend/src/App.tsx (routing pattern):
```typescript
import { ExportPage } from './components/ExportPage';
// In Routes: <Route path="/export" element={<ExportPage />} />
// In nav: <Link to="/export">Export</Link>
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CLI export command with tests</name>
  <files>
    src/event_dedup/cli/__init__.py
    src/event_dedup/cli/__main__.py
    tests/test_export_cli.py
  </files>
  <action>
1. **Create `src/event_dedup/cli/__init__.py`** (empty file).

2. **Create `src/event_dedup/cli/__main__.py`:**

Entry point for `uv run python -m event_dedup.cli export`.

```python
import argparse
import asyncio
import json
import sys
from datetime import datetime
from pathlib import Path

import structlog

from event_dedup.config.settings import get_settings
from event_dedup.db.session import get_session_factory
from event_dedup.export.service import chunk_events, query_and_export
from event_dedup.logging_config import configure_logging


async def run_export(
    created_after: datetime | None,
    modified_after: datetime | None,
    output_dir: Path,
) -> None:
    """Execute the export and write files to output_dir."""
    log = structlog.get_logger()
    settings = get_settings()
    session_factory = get_session_factory()

    async with session_factory() as session:
        events = await query_and_export(session, created_after, modified_after)

    log.info("export_queried", event_count=len(events))

    filters = {
        "created_after": created_after.isoformat() if created_after else None,
        "modified_after": modified_after.isoformat() if modified_after else None,
    }
    chunks = chunk_events(events, filters=filters)

    output_dir.mkdir(parents=True, exist_ok=True)
    for filename, content in chunks:
        filepath = output_dir / filename
        filepath.write_text(content, encoding="utf-8")
        log.info("export_file_written", path=str(filepath), events=json.loads(content)["metadata"]["eventCount"])

    log.info("export_complete", files=len(chunks), directory=str(output_dir))


def main() -> None:
    parser = argparse.ArgumentParser(prog="event_dedup.cli", description="Event Deduplication CLI")
    subparsers = parser.add_subparsers(dest="command")

    export_parser = subparsers.add_parser("export", help="Export canonical events as JSON")
    export_parser.add_argument("--created-after", type=str, default=None, help="ISO datetime filter for created_at (e.g., 2026-02-28T16:00)")
    export_parser.add_argument("--modified-after", type=str, default=None, help="ISO datetime filter for updated_at (e.g., 2026-02-28T16:00)")
    export_parser.add_argument("--output-dir", type=str, default="./export", help="Output directory (default: ./export)")

    args = parser.parse_args()

    if args.command is None:
        parser.print_help()
        sys.exit(1)

    if args.command == "export":
        configure_logging()

        created_after = datetime.fromisoformat(args.created_after) if args.created_after else None
        modified_after = datetime.fromisoformat(args.modified_after) if args.modified_after else None
        output_dir = Path(args.output_dir)

        asyncio.run(run_export(created_after, modified_after, output_dir))


if __name__ == "__main__":
    main()
```

3. **Create `tests/test_export_cli.py`:**

Test the CLI export command:

- **Test `run_export` with seeded DB:** Use `test_session_factory` and `seeded_db` fixtures. Monkeypatch `get_session_factory` to return test factory. Call `run_export(None, None, tmp_path / "out")`. Assert output directory contains at least one `export_*_part_1.json` file. Parse the file and verify it has `events` array with correct count and `metadata`.

- **Test `run_export` with date filter:** Seed DB with events at known timestamps. Call with `created_after` set after the first event's creation. Verify the output only contains filtered events.

- **Test `run_export` with empty result:** Call with a `created_after` far in the future. Verify output file exists with `"events": []`.

- **Test CLI argument parsing:** Use `subprocess` or `argparse` directly to verify `--created-after`, `--modified-after`, `--output-dir` are parsed correctly. For subprocess test, call `uv run python -m event_dedup.cli --help` and verify it doesn't error.

Note: Since `run_export` is an async function that calls `get_session_factory`, monkeypatch the factory function to inject the test session factory. Follow the pattern from `conftest.py`.
  </action>
  <verify>
    <automated>cd /Users/svenkarl/workspaces/event-deduplication && uv run pytest tests/test_export_cli.py -x -v</automated>
  </verify>
  <done>
    - CLI module exists at `src/event_dedup/cli/__main__.py`
    - `uv run python -m event_dedup.cli export --help` shows usage
    - `run_export` writes JSON files to output directory
    - CLI date filters (--created-after, --modified-after) work correctly
    - CLI defaults output-dir to ./export
    - Output files follow `export_{timestamp}_part_{N}.json` naming
    - All CLI tests pass
  </done>
</task>

<task type="auto">
  <name>Task 2: Create frontend export page with download</name>
  <files>
    frontend/src/types/index.ts
    frontend/src/api/client.ts
    frontend/src/components/ExportPage.tsx
    frontend/src/App.tsx
  </files>
  <action>
1. **Add export types to `frontend/src/types/index.ts`:**

```typescript
export interface ExportParams {
  created_after?: string | null;
  modified_after?: string | null;
}
```

2. **Add export function to `frontend/src/api/client.ts`:**

```typescript
export async function exportEvents(params: ExportParams): Promise<void> {
    const res = await fetch(`${API_BASE}/export`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(params),
    });
    if (!res.ok) {
        const err = await res.json().catch(() => ({ detail: `HTTP ${res.status}` }));
        throw new Error(err.detail || `Export failed: ${res.status}`);
    }

    // Extract filename from Content-Disposition header
    const disposition = res.headers.get('Content-Disposition') || '';
    const filename = disposition.match(/filename="(.+)"/)?.[1] || 'export.json';

    // Trigger browser download
    const blob = await res.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}
```

3. **Create `frontend/src/components/ExportPage.tsx`:**

Build an export page with:
- Page title: "Export Events"
- Brief description explaining the export function
- Two `<input type="datetime-local">` fields: "Created After" and "Modified After" (both optional)
- A "Clear Filters" button to reset both date fields
- An "Export" button that calls `exportEvents` with the current filter values
- Loading state: disable button and show "Exporting..." while request is in flight
- Error state: show error message below the button if export fails
- Success state: brief "Download started" message after successful export
- Use Tailwind classes consistent with the rest of the app (white card, shadow, rounded, blue primary button)
- Convert `datetime-local` input values to ISO strings (they come as `"2026-02-28T16:00"`, which is valid ISO format)
- If a datetime field is empty/blank, send `null` for that filter

Layout:
```
Export Events
Export canonical events as JSON files matching the input format.
Events are split into files of max 200 events each.

[Created After: ____datetime-local____]
[Modified After: ____datetime-local____]

[Clear Filters]  [Export]

{error message if any}
{success message if any}
```

4. **Wire into `frontend/src/App.tsx`:**

- Add import: `import { ExportPage } from './components/ExportPage';`
- Add route: `<Route path="/export" element={<ExportPage />} />`
- Add nav link: `<Link to="/export" className="text-sm text-gray-600 hover:text-blue-600">Export</Link>` (place after "Config" link)
  </action>
  <verify>
    <automated>cd /Users/svenkarl/workspaces/event-deduplication/frontend && npx tsc --noEmit</automated>
  </verify>
  <done>
    - Export page renders at /export route
    - Navigation includes "Export" link
    - Datetime pickers for created_after and modified_after work
    - Clear Filters button resets both fields
    - Export button triggers POST /api/export and downloads file
    - Loading, error, and success states are handled
    - TypeScript compiles without errors
  </done>
</task>

</tasks>

<verification>
1. `uv run pytest tests/test_export_cli.py -x -v` -- CLI tests pass
2. `cd frontend && npx tsc --noEmit` -- TypeScript compiles
3. `uv run pytest tests/ -x --timeout=60` -- full test suite passes
4. Manual: `uv run python -m event_dedup.cli export --help` shows usage
5. Manual: Navigate to http://localhost:5173/export, verify page renders with datetime pickers and Export button
</verification>

<success_criteria>
- CLI command `uv run python -m event_dedup.cli export` works with --created-after, --modified-after, --output-dir flags
- CLI writes correctly named JSON files to the output directory
- Frontend export page at /export has datetime pickers and download button
- Frontend triggers file download (JSON or ZIP) on export
- Navigation includes Export link
- All tests pass, TypeScript compiles
</success_criteria>

<output>
After completion, create `.planning/phases/12/12-02-SUMMARY.md`
</output>

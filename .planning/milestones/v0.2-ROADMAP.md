# Milestone v0.2 Roadmap: Configuration, AI Verification, UX & Export

**Timeline:** 2026-02-28
**Status:** Complete (audited)
**Phases:** 5 | **Plans:** 10 | **Requirements:** 20/20 | **Tests:** 445
**Commits:** 32 | **Files changed:** 71 | **Lines:** +6,482 / -192

## Key Accomplishments

1. **Dynamic configuration system** — All matching parameters editable via frontend with immediate effect, DB-backed with Fernet encryption for API keys
2. **AI matching verification & indicators** — End-to-end verified, `ai_assisted` flag on canonical events, purple/orange/gray tier badges in UI
3. **Time gap penalty & venue matching** — 4-tier time model prevents false merges of sequential events; venue name fuzzy matching within <1km proximity
4. **Frontend UX improvements** — Chip selectors for city/category, 7 sortable columns, configurable rows per page (25/50/100/200/ALL)
5. **Export function** — API + CLI + frontend export of canonical events as input-format JSON with date filtering and 200-event chunking
6. **Title veto threshold** — Prevents auto-merge when titles clearly differ (cinema/same-venue scenario)

---

## Phases

### Phase 8: Dynamic Configuration System
**Goal:** All matching parameters editable via frontend with immediate effect on next pipeline run
**Requirements:** CFG-01, CFG-02, CFG-03, CFG-04, CFG-05
**Plans:** 2 plans

Plans:
- [x] 08-01-PLAN.md — Backend: DB model, migration, encryption, API endpoints, worker config loading, tests
- [x] 08-02-PLAN.md — Frontend: config page with grouped sections, API key management, AI toggle

**Scope:**
- Database-backed config model (replaces YAML-only config)
- REST API endpoints: GET config, PATCH config (partial updates)
- Gemini API key: stored encrypted/hashed, write-only in API (never returned in GET)
- Frontend config page: grouped sections (Scoring, Thresholds, Date/Time, Geo, AI, Cluster)
- Worker loads config from DB at pipeline start (falls back to YAML defaults if no DB config)

### Phase 9: AI Matching Verification & Indicators
**Goal:** AI matching is verified end-to-end and its involvement is visible throughout the system
**Requirements:** AIM-01, AIM-02, AIM-03, AIM-04
**Depends on:** Phase 8 (API key + on/off toggle in config)
**Plans:** 2 plans

Plans:
- [x] 09-01-PLAN.md — Backend: DB migration, model, pipeline computation, persistence, API schema, integration test
- [x] 09-02-PLAN.md — Frontend: TypeScript types, AI badge in event list/detail, ConfidenceIndicator tier styling

**Scope:**
- Integration test: process test events through full pipeline with AI enabled (mock or real Gemini)
- New `ai_assisted` boolean field on CanonicalEvent model + migration
- Pipeline sets `ai_assisted=True` when any cluster pair has `tier="ai"`
- Frontend: AI badge in event list, AI detail in ConfidenceIndicator, tier-based styling

### Phase 10: Time Gap Penalty & Venue Name Matching
**Goal:** Sequential events at the same location 2h+ apart are no longer falsely matched; events at different venues in the same city are correctly distinguished
**Requirements:** TGP-01, TGP-02
**Depends on:** Phase 8 (penalty factor in config)
**Plans:** 2 plans

Plans:
- [x] 10-01-PLAN.md — Backend: DateConfig + time gap penalty, GeoConfig + venue name matching, tests
- [x] 10-02-PLAN.md — Frontend: TypeScript types, DateTimeSection + GeoSection config fields

**Scope:**
- Add 4th time proximity tier: 2h+ gaps get `time_gap_penalty_factor` (0.15) instead of `far_factor` (0.3)
- Add configurable `time_gap_penalty_hours` (default 2.0) and `time_gap_penalty_factor` (default 0.15) to DateConfig
- Add venue name fuzzy matching in geo scorer when events are in close proximity (<1km)
- Add configurable `venue_match_distance_km` (default 1.0) and `venue_mismatch_factor` (default 0.5) to GeoConfig
- All parameters exposed in dynamic config (Phase 8)

### Phase 11: Frontend UX Improvements
**Goal:** Event browsing is faster and more flexible with filter chips, sorting, and page sizing
**Requirements:** UIX-01, UIX-02, UIX-03, UIX-04
**Depends on:** Phase 9 (AI indicator column in list)
**Plans:** 2 plans

Plans:
- [x] 11-01-PLAN.md — Backend: multi-filter, sort, size cap, and distinct-value endpoints
- [x] 11-02-PLAN.md — Frontend: ChipSelector, sortable headers, page size selector

**Scope:**
- API endpoints: GET distinct categories, GET distinct cities (for autocomplete)
- Category chip selector: autocomplete dropdown, selected chips with "x" remove, multi-select
- City chip selector: same UX pattern as categories
- Column sorting: clickable headers with sort direction indicator, backend `sort_by` + `sort_dir` params
- Page size selector: 25 / 50 / 100 / 200 / ALL options, persisted in URL params

### Phase 12: Export Function
**Goal:** Operators can export canonical events as JSON files matching the input format
**Requirements:** EXP-01, EXP-02, EXP-03, EXP-04, EXP-05
**Plans:** 2 plans

Plans:
- [x] 12-01-PLAN.md — Backend: export service module, API endpoint, transformation, chunking
- [x] 12-02-PLAN.md — CLI export command, frontend export page

**Scope:**
- Core export logic as shared module (used by both API and CLI)
- API endpoint: POST /api/export with optional `created_after`, `modified_after` datetime filters
- CLI command: `uv run python -m event_dedup.cli export`
- Transforms canonical events to input-format JSON
- Splits output into chunks of max 200 events
- API returns ZIP archive if multiple files, single JSON if ≤200 events
- Frontend: Export page with datetime pickers and download button

---

## Phase Summary

| Phase | Title | Requirements | Plans | Depends On |
|-------|-------|-------------|-------|------------|
| 8 | Dynamic Configuration System | CFG-01..05 (5) | 2 | — |
| 9 | AI Matching Verification & Indicators | AIM-01..04 (4) | 2 | Phase 8 |
| 10 | Time Gap Penalty & Venue Matching | TGP-01..02 (2) | 2 | Phase 8 |
| 11 | Frontend UX Improvements | UIX-01..04 (4) | 2 | Phase 9 |
| 12 | Export Function | EXP-01..05 (5) | 2 | — |

**Total: 5 phases, 10 plans, 20 requirements**

## Decisions Made

- Singleton row (id=1) for config_settings — simple, no multi-tenant complexity
- Fernet encryption with plain-text fallback for dev convenience
- Per-run config loading from DB with YAML fallback for backward compat
- Deep merge for partial PATCH updates to preserve unset fields
- HTML details/summary for collapsible config sections (native, no extra deps)
- Per-section save with TanStack Query mutation for granular updates
- Write-only API key with clear button for secure key management
- ai_assisted computed in pipeline (not synthesizer or API route) to avoid N+1 queries
- tier.startswith("ai") to catch all AI tier variants
- TierBadge component with purple/orange/gray color coding
- 4-tier time proximity model: exact/close/far/gap penalty (was 3-tier)
- Venue name matching only within close proximity (<1km) to avoid penalizing distant events
- RapidFuzz token_sort_ratio >= 0.5 threshold for venue similarity
- Multi-value city filter with OR semantics, multi-value category filter with AND semantics
- ChipSelector as controlled component, no component library needed
- size=0 in UI maps to size=10000 for API (ALL sentinel)
- nullslast for desc sort, nullsfirst for asc sort on nullable columns
- POST for export endpoint (body parameters, matches roadmap)
- Title veto threshold (0.30) to prevent auto-merge when titles clearly differ

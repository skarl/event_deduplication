# =============================================================================
# Matching Pipeline Configuration
# =============================================================================
# All parameters have sensible defaults.  Only include overrides here.
# See src/event_dedup/matching/config.py for the full parameter reference.

# --- Signal weights (must sum to 1.0) ---
scoring:
  date: 0.30          # Date overlap between events
  geo: 0.25           # Geographic proximity
  title: 0.30         # Title fuzzy-match similarity
  description: 0.15   # Description similarity

# --- Decision thresholds ---
thresholds:
  high: 0.75           # Combined score >= high  -> "match"
  low: 0.35            # Combined score <= low   -> "no_match"
                        # Between low and high    -> "ambiguous"

# --- Geographic scoring ---
geo:
  max_distance_km: 10.0    # Events beyond this distance score 0.0
  min_confidence: 0.85     # Geo coordinates below this confidence are ignored
  neutral_score: 0.5       # Score when geo data is missing or low-confidence
  venue_match_distance_km: 1.0   # Compare venue names within this distance
  venue_mismatch_factor: 0.5     # Multiplier when venue names don't match

# --- Date/time scoring ---
date:
  time_tolerance_minutes: 30   # Times within this range are a perfect match
  time_close_minutes: 90       # Times within this range get close_factor
  close_factor: 0.7            # Multiplier for "close" time matches
  far_factor: 0.3              # Multiplier for times farther apart
  time_gap_penalty_hours: 2.0  # Hours threshold for the 4th time tier
  time_gap_penalty_factor: 0.15  # Multiplier for times beyond gap threshold

# --- Title scoring ---
title:
  primary_weight: 0.7     # Weight for token_sort_ratio (primary signal)
  secondary_weight: 0.3   # Weight for token_set_ratio (secondary signal)
  blend_lower: 0.40       # Below this, use only primary score
  blend_upper: 0.80       # Above this, use only primary score
  cross_source_type:       # Override for artikel-terminliste pairs
    primary_weight: 0.4    # Less weight on sort (penalizes length diff)
    secondary_weight: 0.6  # More weight on set (rewards token overlap)
    blend_lower: 0.25      # Wider blend range to catch more asymmetric matches
    blend_upper: 0.95

# --- Clustering ---
cluster:
  max_cluster_size: 15           # Flag clusters larger than this for review
  min_internal_similarity: 0.40  # Minimum pairwise similarity within cluster

# --- Canonical event creation ---
canonical:
  field_strategies:
    title: longest_non_generic
    short_description: longest
    description: longest
    highlights: union
    location_name: most_complete
    location_city: most_frequent
    location_street: most_complete
    geo: highest_confidence
    categories: union
    is_family_event: any_true
    is_child_focused: any_true
    admission_free: any_true

# --- Category-aware weight overrides ---
# When both events in a pair share a category listed here,
# use these weights instead of the default scoring weights.
# Priority determines which override applies when multiple categories match.
category_weights:
  priority:
    - fasnacht
    - versammlung
  overrides:
    fasnacht:
      date: 0.30
      geo: 0.30
      title: 0.25         # Lower: carnival titles vary wildly between sources
      description: 0.15
    versammlung:
      date: 0.25
      geo: 0.20
      title: 0.40         # Higher: political events have very consistent titles
      description: 0.15
